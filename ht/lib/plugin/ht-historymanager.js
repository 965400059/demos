!function(p,_,H){"use strict";var a="ht",y=p[a],C=y.Default,l=C.def,e=C.getInternal();y.HistoryManager=function(N){this._histories=[],this.setDataModel(N)},l(y.HistoryManager,_,{ms_ac:["dataModel","histories","historyIndex","maxHistoryCount","disabled"],ms_fire:1,_historyIndex:-1,_betweenTransaction:0,_maxHistoryCount:200,_disabled:!1,ignoredPropertyMap:{imageLoaded:!0,children:!0,attaches:!0,shape:!0,childChange:!0,agentChange:!0,sourceAgent:!0,targetAgent:!0,edgeGroup:!0,"*":!0},beginInteraction:function(){this.beginTransaction()},endInteraction:function(){this.endTransaction()},beginTransaction:function(){if(!this._disabled){var L=this;L._betweenTransaction++,1===L._betweenTransaction&&(L._transactionHistories=[])}},endTransaction:function(){if(!this._disabled){var V=this,r=V._histories;V._betweenTransaction>0&&V._betweenTransaction--,0===V._betweenTransaction&&(V._transactionHistories&&V._transactionHistories.length&&(r=r.slice(0,V._historyIndex+1),r.push(V._transactionHistories),r.length>V._maxHistoryCount&&(r=r.slice(r.length-V._maxHistoryCount)),V.setHistories(r),V.setHistoryIndex(r.length-1,!0)),delete V._transactionHistories)}},setDataModel:function(A){var h=this,O=h._dataModel;O!==A&&(O&&(delete O._historyManager,O.ump(h.handleDataModelPropertyChange,h),O.umm(h.$5p,h),O.umd(h.$6p,h),O.removeHierarchyChangeListener(h.handleHierarchyChange,h),O.removeIndexChangeListener(h.handleIndexChange,h)),h._dataModel=A,A&&(A._historyManager=h,A.mp(h.handleDataModelPropertyChange,h),A.mm(h.$5p,h),A.md(h.$6p,h),A.addHierarchyChangeListener(h.handleHierarchyChange,h),A.addIndexChangeListener(h.handleIndexChange,h)),h.fp("dataModel",O,A),h.clear())},setHistoryIndex:function(M,z){var S=this,P=S._historyIndex,T=S._histories.length;if(-1>M?M=-1:M>=T&&(M=T-1),P!==M){if(!z){var H=M-P;H>0?S.$2p(H):0>H&&S.$1p(-H)}S._historyIndex=M,S.fp("historyIndex",P,M),S.dataModel&&S.dataModel.onHistoryManagerChanged()}},setMaxHistoryCount:function(F){var Z=this,B=Z._histories,h=Z._maxHistoryCount;(!F||0>=F)&&(F=10),h!==F&&(Z._maxHistoryCount=F,Z.fp("maxHistoryCount",h,F),B.length>F&&Z.clear())},cloneValue:function(W){return y.Default.clone(W)},isPropertyUndoable:function(x){return x&&!this.ignoredPropertyMap[x]},$5p:function(i){this.handleChange(i,i.kind)},$6p:function(M){this.handleChange(M,"property")},handleHierarchyChange:function(o){this.handleChange(o,"hierarchy")},handleIndexChange:function(k){this.handleChange(k,"index")},handleDataModelPropertyChange:function(T){this.handleChange(T,"dataModelProperty")},toChildrenInfo:function(L){var s={};return s.data=L,s.children=[],L.eachChild(function(X){s.children.push(this.toChildrenInfo(X))},this),s},restoreChildren:function(C){var i=C.data;C.children.forEach(function(t){var w=t.data;w.getParent()!==i&&i.addChild(w),this._dataModel.contains(w)||this._dataModel.add(w),this.restoreChildren(t)},this)},handleChange:function(z,a){var h=this;if(!(h._disabled||h._isUndoRedoing||C.loadingRefGraph)){var c,L=(h._histories,z.data),o=z.property;if(!L||!(L._refGraph||L instanceof y.RefGraph)){if("property"===a)h.isPropertyUndoable(o,L)&&(c={kind:a,data:L,property:o,oldValue:h.cloneValue(z.oldValue,L,o),newValue:h.cloneValue(z.newValue,L,o),event:z});else if("hierarchy"===a||"index"===a)c={kind:a,data:L,oldIndex:z.oldIndex,newIndex:z.newIndex,event:z};else if("clear"===a)c={kind:a,json:z.json,event:z};else if("add"===a){if(c={kind:a,data:L,event:z,childrenInfo:this.toChildrenInfo(L),parent:L.getParent()},c.parent){var V=h._dataModel.getSiblings(L);c.siblingsIndex=V.indexOf(L)}L instanceof y.Node&&(c.host=L.getHost(),c.attaches=L.getAttaches()?L.getAttaches().toArray():H),L instanceof y.Edge&&(c.source=L.getSource(),c.target=L.getTarget())}else"remove"===a?c={kind:a,data:L,event:z}:"dataModelProperty"===a&&(c={kind:a,property:o,oldValue:h.cloneValue(z.oldValue,L,o),newValue:h.cloneValue(z.newValue,L,o),event:z});h.addHistory(c)}}},addHistory:function(Y){var C=this;if(Y)if(C._betweenTransaction){var J=!1;if("property"===Y.kind||"dataModelProperty"===Y.kind)for(var p=C._transactionHistories.length-1;p>=0;p--){var d=C._transactionHistories[p];if(Y.kind===d.kind&&Y.property===d.property&&Y.data===d.data){Y.oldValue=d.oldValue,C._transactionHistories[p]=Y,J=!0;break}}J||C._transactionHistories.push(Y)}else{var F=C._histories;F=F.slice(0,C._historyIndex+1),F.push([Y]),F.length>C._maxHistoryCount&&(F=F.slice(F.length-C._maxHistoryCount)),C.setHistories(F),C.setHistoryIndex(F.length-1,!0)}},canUndo:function(){return!this._disabled&&this._historyIndex>=0&&this._historyIndex<this._histories.length},canRedo:function(){return!this._disabled&&this._historyIndex>=-1&&this._historyIndex<this._histories.length-1},undo:function(s){(!s||0>=s)&&(s=1),this.setHistoryIndex(this._historyIndex-s)},$1p:function(y){if(this.canUndo()){var U,z=this,l=z._dataModel,Z=z._histories,q=z._historyIndex;for(z._isUndoRedoing=!0,C.setIsolating(!0);y>0;){if(q>=0&&q<Z.length){U=Z[q],q--;for(var i=U.length-1;i>=0;i--){var $=U[i],p=$.kind,s=$.data,E=$.property,x=$.event,c=this.cloneValue($.oldValue,s,E);if($.undo)$.undo();else if("add"===p)l.remove(s,{keepChildren:!0});else if("remove"===p)l.contains(s)||l.add(s,x.rootsIndex,x.datasIndex);else if("clear"===p)l.deserialize(C.clone($.json));else if("property"===p)if("parent"===E)c?c.addChild(s,x.oldIndex):(s.setParent(c),x.oldIndex>=0&&l.moveTo(s,x.oldIndex));else{var L=null;0===E.indexOf("a:")?(L="attr",E=E.replace("a:","")):0===E.indexOf("s:")?(L="style",E=E.replace("s:","")):0===E.indexOf("f:")&&(L="field",E=E.replace("f:","")),e.setPropertyValue(s,L,E,c)}else if("dataModelProperty"===p){var L=null;0===E.indexOf("a:")?(L="attr",E=E.replace("a:","")):0===E.indexOf("s:")?(L="style",E=E.replace("s:","")):0===E.indexOf("f:")&&(L="field",E=E.replace("f:","")),e.setPropertyValue(l,L,E,c)}else"hierarchy"===p?l.moveTo(s,$.oldIndex):"index"===p&&l.moveToIndex(s,$.oldIndex)}}y--}C.setIsolating(!1),delete z._isUndoRedoing}},redo:function(b){(!b||0>=b)&&(b=1),this.setHistoryIndex(this._historyIndex+b)},$2p:function(T){if(this.canRedo()){var h,P=this,b=P._dataModel,F=P._histories,D=P._historyIndex;for(P._isUndoRedoing=!0,C.setIsolating(!0);T>0;){if(D>=-1&&D<F.length-1){D++,h=F[D];for(var x=0;x<h.length;x++){var w=h[x],k=w.kind,N=w.data,g=w.property,p=w.event,V=this.cloneValue(w.newValue,N,g);if(w.redo)w.redo();else if("add"===k)w.parent&&!N.getParent()&&w.parent.addChild(N,w.siblingsIndex),b.contains(N)||b.add(N,p.rootsIndex,p.datasIndex),this.restoreChildren(w.childrenInfo),N instanceof y.Node&&(N.setHost(w.host),w.attaches&&w.attaches.forEach(function(Q){Q.setHost(N)})),N instanceof y.Edge&&(N.setSource(w.source),N.setTarget(w.target));else if("remove"===k)b.remove(N);else if("clear"===k)b.clear();else if("property"===k)if("parent"===g)V?V.addChild(N,p.newIndex):(N.setParent(V),p.newIndex>=0&&b.moveTo(N,p.newIndex));else{var K=null;0===g.indexOf("a:")?(K="attr",g=g.replace("a:","")):0===g.indexOf("s:")?(K="style",g=g.replace("s:","")):0===g.indexOf("f:")&&(K="field",g=g.replace("f:","")),e.setPropertyValue(N,K,g,V)}else if("dataModelProperty"===k){var K=null;0===g.indexOf("a:")?(K="attr",g=g.replace("a:","")):0===g.indexOf("s:")?(K="style",g=g.replace("s:","")):0===g.indexOf("f:")&&(K="field",g=g.replace("f:","")),e.setPropertyValue(b,K,g,V)}else"hierarchy"===k?b.moveTo(N,w.newIndex):"index"===k&&b.moveToIndex(N,w.newIndex)}}T--}C.setIsolating(!1),delete P._isUndoRedoing}},clear:function(){this.setHistories([]),this.setHistoryIndex(-1,!0),this._betweenTransaction=0,delete this._transactionHistories}})}("undefined"!=typeof global?global:"undefined"!=typeof self?self:"undefined"!=typeof window?window:(0,eval)("this"),Object);